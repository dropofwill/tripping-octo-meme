<!DOCTYPE html>
<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<head>
	<style>
		.container {
			width: 90%;
			margin: 0 auto;
			background: azure;
		}
		svg {
			-webkit-tap-highlight-color: rgba(0,0,0,0);
			height: 100%;
		}

		.background {
			fill: none;
			pointer-events: all;
		}

		.subunit {
			-ms-touch-action: none;
			cursor: pointer;
		}
		
		.subunit.hover {
			fill: #C1CEBE;
		}

		.subunit.active {
			fill: #A6CF9C;
		}

		button {
			background-color: rgba(118,183,138,1);
			border: none;
			padding: 10px;
			position: relative;
			font-size: 12px;
			color: #fff;
			border-radius: 8px;
			box-shadow: 3px 3px 0px rgba(118,183,138,0.3);
			transition: 0.1s;
			outline: 0;
		}

		button:hover,
		button:focus {
			border:none;
			outline: 0;
		}

		button:active {
			box-shadow: 0 0 0 0 rgba(0,0,0,0.3);
			-webkit-transform: translate(1px, 4px);
				-ms-transform: translate(1px, 4px);
				transform: translate(1px, 4px);
			outline: 0;
		 }
	</style>
</head>
<body>
	<div class="container">
		<button id="reset">Reset</button>
		<button id="zoom_in">+</button>
		<button id="zoom_out">-</button>
		<button id="lock">Lock Zoom Gestures</button>
		<button id="toggle">Toggle Map/List</button>
		<select id="selector" name="selector">
			<option disabled selected>Select a Country</option>
		</select>
	</div>

	<script src="scripts/fastclick.js"></script>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script>

	window.addEventListener('load', function() {
    FastClick.attach(document.body);
	}, false);

	// Set Aspect Ratio in pixels
	var width = 960,
			height = 500,
			active = d3.select(null),
			hover = d3.select(null),
			locked = false,
			listSubunits = [],
			lock_btn = document.getElementById("lock"),
			toggle_btn = document.getElementById("toggle"),
			countrySelector = document.getElementById("selector");

	// The Map projection settings
	// UK
	//var projection = d3.geo.albers()
	//	.center([0, 55.4])
	//	.rotate([4.4, 0])
	//	.parallels([50, 60])
	//	.scale(6000)
	//	.translate([width / 2, height / 2]);

	// USA	
	var projection = d3.geo.albersUsa()
    .scale(1000)
    .translate([width / 2, height / 2]);
	
	// Apply the projection to the path
	var path = d3.geo.path()
		.projection(projection);

	// Set the zoom behavior defaults
	var zoom = d3.behavior.zoom()
		.scale(1)
		.translate([0,0])
    .scaleExtent([1, 6])
    .on("zoom", zoomed);

	// Add the svg to the .container element, stop event propogation
	var svg = d3.select(".container").append("svg")
		.attr("viewBox", "0 0 " + width + " " + height )
		.attr("preserveAspectRatio", "xMidYMid meet")
		.attr("id", "svg--map")
		.on("click", stopped, true);

	// Apply the zoom settings to the root as gestures and events
	svg.call(zoom)
		.call(zoom.event)

	// A rectangle to reset the view, drawn behind the map
	svg.append("rect")
		.attr("class", "background")
		.attr("width", width)
		.attr("height", height)
		.on("click", reset);
		
	// Group the map features
	var features = svg.append("g");
	
	// Load the actual map data
	d3.json("data/usa_states_500k_topo.json", function(error, map) {
		if (error) return console.error(error);
		
		console.log(map);
		console.log(topojson.feature(map, map.objects.states));

		// The individual states/countries
		var subunits = topojson.feature(map, map.objects.states).features;
		// The entire map, used for the nice border
		var unit = topojson.feature(map, map.objects.states);

		console.log(subunits);
		console.log(unit);
		
		var i = Math.floor(Math.random() * 10) + 1;

		features.append("path")
			.datum(unit)
				.attr("class", "country")
				.attr("d", path)
				.attr("stroke", "#ddd")
				.attr("fill", "#ddd")
				.attr("stroke-width", 7)
				.attr("stroke-linejoin", "round");

		features.selectAll(".subunit")
				.data(subunits)
			.enter().append("path")
				.attr("d", path)
				.attr("class", function(d) { 
						var displayName = d.properties.NAME;
						var name = d.properties.NAME.replace(/\.+\ +/,"");
						listSubunits.push(name);
						var el = document.createElement("option");
						el.setAttribute("value", name);
						el.textContent = displayName;
						countrySelector.appendChild(el);
	
						return "subunit " + name; })
				.attr("fill", "#f6f4f2")
				//.attr("fill", function() { i++; return chooseColor(i); })
				.attr("stroke", "#999")
				//.attr("stroke", "#fff")
				.attr("stroke-width", 1)
				.attr("stroke-linejoin", "round")
				.on("click", clicked)
				.on("mouseover", mouseover)
				.on("mouseout", mouseout);
	});

	d3.select("#reset").on("click", reset);
	d3.select("#lock").on("click", lock);
	d3.select("#zoom_in").on("click", function() { zoomDir("in"); });
	d3.select("#zoom_out").on("click", function() { zoomDir("out"); });
	countrySelector.addEventListener("change", function(e) { 
			var classSelected = "." + this.options[this.selectedIndex].value.toString();
			var d = d3.select(classSelected);
			d.each(clicked);
	});
	toggle_btn.addEventListener("click", function(e) {
			var d = d3.selectAll(".subunit");
			d.each(toggle);
	});

	function zoomed() {
		svg.selectAll("path")
			.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");

		svg.selectAll(".subunit")
			.style("stroke-width", 1/ d3.event.scale + "px");

		svg.selectAll(".country")
			.style("stroke-width", function() {
					return parseFloat(this.getAttribute("stroke-width") / d3.event.scale);
			});
	}

	// This is called on click and onchange of the select box
	function clicked(d) {

		if (active.node() === this) return reset();
		active.classed("active", false);
		active = d3.select(this).classed("active", true);

		var bounds = path.bounds(d),
				dx = bounds[1][0] - bounds[0][0],
				dy = bounds[1][1] - bounds[0][1],
				x = (bounds[0][0] + bounds[1][0]) / 2,
				y = (bounds[0][1] + bounds[1][1]) / 2,
				scale = 0.9 / Math.max(dx / width, dy / height),
				translate = [width / 2 - scale * x, height / 2 - scale * y];

		svg.transition()
			.duration(1000)
			.call(zoom.translate(translate).scale(scale).event);

		// Account for the select a country item
		var name = d.properties.NAME.replace(/\.+\ +/,"")
		var index = listSubunits.indexOf(name) + 1;
		// Keep the select box up to date, even if navigating by click
		countrySelector.options[index].selected = true;
	}

	function reset() {
		active.classed("active", false);
		active = d3.select(null);

		svg.transition()
				.duration(750)
				.call(zoom.translate([0, 0]).scale(1).event);

		countrySelector.options[0].selected = true;
	}

	function toggle(d) {
		var name = d.properties.NAME.replace(/\.+\ +/,"")
		var index = listSubunits.indexOf(name);
		var offset = index * 1500;


		console.log(offset);	
		d3.select(this)
			.transition()
			.attr("transform", function(d) {
				var bbox = this.getBBox(),
						scaleRatio,
						dX,
						dY;
				
				scaleRatio =  100 / bbox.height;
				dX = -1 * bbox.x;
				//dY = (-1 * bbox.y);
				dY = (-1 * bbox.y) + (offset * scaleRatio);
				//dY = offset;
				console.log(scaleRatio, dX, dY, offset / bbox.height);

				return "scale(" + scaleRatio + ") translate(" + dX + "," + dY + ")";
			});
	}

	function lock() {
		if (!locked) {
			locked = true;
			lock_btn.innerHTML = "Unlock Zoom Gestures";
			svg.on(".zoom", null);
		}
		else {
			locked = false;
			lock_btn.innerHTML = "Lock Zoom Gestures";
			svg.call(zoom);
		}
	}

	function zoomDir(dir) {
		h = parseFloat(document.getElementById("svg--map").clientHeight);
		w = parseFloat(document.getElementById("svg--map").clientWidth);

		if (dir == "in") {
			var newZoom = zoom.scale() * 1.5;
			var newX = ((zoom.translate()[0] - (width / 2)) * 1.5) + width / 2;
			var newY = ((zoom.translate()[1] - (height / 2)) * 1.5) + height / 2;
		}
		else {
			var newZoom = zoom.scale() * 0.75; 
			var newX = ((zoom.translate()[0] - (width / 2)) * 0.75) + width / 2;
			var newY = ((zoom.translate()[1] - (height / 2)) * 0.75) + height / 2;
		}

		svg.transition()
				.duration(750)
				.call(zoom.translate([newX, newY]).scale(newZoom).event);
	}

	function mouseover(d) {
		hover.classed("hover", false);
		hover = d3.select(this).classed("hover", true);
	}
	
	function mouseout(d) {
		hover.classed("hover", false);
	}
	
	function stopped() {
		if (d3.event.defaultPrevented) d3.event.stopPropagation();
	}
	
	function chooseColor(ith, colors) {
		var colors = typeof colors !== 'undefined' ? colors : ["#CDA274", "#BCBAC8", "#A6CF9C", "#776D62","#D0C98C", "#5B584B", "#C2BCC8", "#BE8F7E", "#A1C9AC"] 
		i = ith%colors.length
		console.log(i, ith, colors[i]);
		return colors[i];
	}
	</script>
</body>
</html>
